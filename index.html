<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸° í€´ì¦ˆ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html, body { height:100%; margin:0; font-family: "Noto Sans KR", sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr auto; }
    header, footer { padding:8px 14px; }
    header { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { background:#eee; border-radius:10px; padding:4px 10px; font-size:12px; }
    #map { width:100%; height:100%; background:#f3f5f8; }
    .panel { display:grid; gap:8px; padding:10px 14px; background:#fafafa; border-top:1px solid #ddd; }
    .question { font-weight:700; }
    .choices { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
    button.choice { padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#fff; }
    button.choice:hover { border-color:#666; }
    .result { min-height:24px; font-weight:600; }
    .controls { display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap; align-items:center; }
    .btn { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .progress { height:8px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background:#1a73e8; transition:width .3s; }
    .tiny { font-size:12px; color:#555; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="badge">ğŸŒ ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸°</div>
    <div class="badge">ë¹Œë“œ v2025-08-30-8</div>
    <div class="badge" id="scoreBadge">ì ìˆ˜ 0</div>
    <div class="badge" id="roundBadge">ë¬¸ì œ 0/10</div>
    <div class="badge" id="streakBadge">ì—°ì†ì •ë‹µ 0</div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div class="question" id="question">ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?</div>
    <div class="choices" id="choices"></div>
    <div class="result" id="result"></div>
    <div class="controls">
      <div class="tiny" id="hintArea">íŒíŠ¸: ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œë¡œ ë‚˜ì˜µë‹ˆë‹¤</div>
      <div>
        <button class="btn" id="btnHint">íŒíŠ¸</button>
        <button class="btn primary" id="btnNext" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
        <button class="btn" id="btnRestart">ì²˜ìŒë¶€í„°</button>
      </div>
    </div>
  </div>

  <footer class="tiny">Â© 2025 êµ­ê°€í€´ì¦ˆ â€” êµ­ê¸°ì¶œì²˜: flagcdn.com</footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
const TOTAL_QUESTIONS=10,CHOICES_COUNT=4,HIGHLIGHT_COLOR="#ff5722";
let map,countryLayer,allFeatures=[],remainingIds=[],current=null,score=0,round=0,streak=0,hintLevel=0;

// === ìºì‹œ & ë§¤í•‘ ===
const korCache=new Map(),infoCache=new Map();
const nameFix={"South Korea":"Korea (Republic of)","North Korea":"Korea (Democratic People's Republic of)","USA":"United States"};
const overrides={"Korea (Republic of)":"ëŒ€í•œë¯¼êµ­","Korea (Democratic People's Republic of)":"ë¶í•œ","United States":"ë¯¸êµ­","China":"ì¤‘êµ­","Japan":"ì¼ë³¸","France":"í”„ë‘ìŠ¤","Italy":"ì´íƒˆë¦¬ì•„","Brazil":"ë¸Œë¼ì§ˆ","Germany":"ë…ì¼","United Kingdom":"ì˜êµ­"};
const continentKor={"Africa":"ì•„í”„ë¦¬ì¹´","Americas":"ì•„ë©”ë¦¬ì¹´","Asia":"ì•„ì‹œì•„","Europe":"ìœ ëŸ½","Oceania":"ì˜¤ì„¸ì•„ë‹ˆì•„"};
const foodHints={"Korea (Republic of)":"ê¹€ì¹˜, ë¶ˆê³ ê¸°","Japan":"ìŠ¤ì‹œ, ë¼ë©˜","Italy":"í”¼ì, íŒŒìŠ¤íƒ€","France":"ë°”ê²ŒíŠ¸, í¬ë£¨ì•„ìƒ","United States":"í–„ë²„ê±°, í•«ë„ê·¸","China":"ë§Œë‘, í› ê¶ˆ","India":"ì»¤ë¦¬, ë¹„ë¥´ì•¼ë‹ˆ","Brazil":"ìŠˆí•˜ìŠ¤ì½”","Mexico":"íƒ€ì½”, ë¶€ë¦¬ë˜"};
const landmarkHints={"France":"ì—í íƒ‘","Italy":"ì½œë¡œì„¸ì›€","United States":"ììœ ì˜ ì—¬ì‹ ìƒ","China":"ë§Œë¦¬ì¥ì„±","Japan":"í›„ì§€ì‚°","India":"íƒ€ì§€ë§ˆí• ","Brazil":"ë¦¬ìš° ì˜ˆìˆ˜ìƒ"};

// === UI ===
const scoreBadge=document.getElementById("scoreBadge"),roundBadge=document.getElementById("roundBadge"),streakBadge=document.getElementById("streakBadge"),progressBar=document.getElementById("progressBar"),choicesEl=document.getElementById("choices"),resultEl=document.getElementById("result"),hintArea=document.getElementById("hintArea"),btnHint=document.getElementById("btnHint"),btnNext=document.getElementById("btnNext"),btnRestart=document.getElementById("btnRestart"),questionEl=document.getElementById("question");

// === REST Countries ===
async function queryCountry(nameEng){
  const q=nameFix[nameEng]||nameEng;
  let url=`https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fullText=true&fields=name,translations,capital,region,cca2`;
  let res=await fetch(url);
  if(!res.ok){url=`https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fields=name,translations,capital,region,cca2`;res=await fetch(url);}
  if(res.ok){const d=await res.json();return Array.isArray(d)?d[0]:null;}
  return null;
}
async function getKorName(nameEng){
  if(korCache.has(nameEng))return korCache.get(nameEng);
  if(overrides[nameEng]){korCache.set(nameEng,overrides[nameEng]);return overrides[nameEng];}
  const hit=await queryCountry(nameEng);
  const kor=hit?.translations?.kor?.common||hit?.translations?.kor?.official||hit?.name?.common||nameEng;
  korCache.set(nameEng,kor);return kor;
}
async function getCountryInfo(nameEng){
  if(infoCache.has(nameEng))return infoCache.get(nameEng);
  const hit=await queryCountry(nameEng);
  const out={capital:hit?.capital?hit.capital[0]:null,cca2:hit?.cca2||null,region:hit?.region||null};
  infoCache.set(nameEng,out);return out;
}

// === ì§€ë„ ===
function initMap(){
  map=L.map("map",{renderer:L.svg(),zoomSnap:.1,minZoom:1.5});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:"&copy;OSM &copy;CARTO",subdomains:"abcd"}).addTo(map);
  map.setView([20,0],2);
}
async function loadData(){
  const topo=await fetch("https://unpkg.com/world-atlas@2/countries-110m.json").then(r=>r.json());
  const geo=topojson.feature(topo,topo.objects.countries);
  countryLayer=L.geoJSON(geo,{style:{weight:.8,color:"#888",fillColor:"#dfe7ef",fillOpacity:.8},onEachFeature:(f,l)=>{
    const name=f.properties?.name||f.properties?.admin;if(!name)return;
    allFeatures.push({id:String(f.id),nameEng:name,layer:l});
  }}).addTo(map);
  allFeatures=allFeatures.filter(r=>r.nameEng&&!/antarctica/i.test(r.nameEng));
  remainingIds=allFeatures.map(r=>r.id);
}

// === utils ===
const shuffle=a=>a.sort(()=>Math.random()-.5),sample=(a,n)=>shuffle(a.slice()).slice(0,n);
function updateBadges(){scoreBadge.textContent=`ì ìˆ˜ ${score}`;roundBadge.textContent=`ë¬¸ì œ ${round}/${TOTAL_QUESTIONS}`;streakBadge.textContent=`ì—°ì†ì •ë‹µ ${streak}`;progressBar.style.width=`${(round/TOTAL_QUESTIONS)*100}%`;}
function setResult(t,ok){resultEl.textContent=t;resultEl.style.color=ok?"#0a7d2b":"#c62828";}

// === êµ­ê¸° íŒ¨í„´ ===
function waitForPaths(rec){return new Promise(res=>{const tick=()=>{const el=rec.layer.getElement?.();if(el?.querySelectorAll("path").length)res(el);else requestAnimationFrame(tick);};tick();});}
async function fillWithFlag(rec){
  try{
    const info=await getCountryInfo(rec.nameEng);
    const code=info.cca2?.toLowerCase();if(!code)return;
    const flagUrl=`https://flagcdn.com/w320/${code}.png`;
    const head=await fetch(flagUrl,{method:"HEAD"});if(!head.ok)return;
    const groupEl=await waitForPaths(rec);
    const svg=map.getPane("overlayPane").querySelector("svg");if(!svg)return;
    let defs=svg.querySelector("defs");if(!defs){defs=document.createElementNS("http://www.w3.org/2000/svg","defs");svg.prepend(defs);}
    const bbox=groupEl.getBBox();const patId=`flagpat-${Math.random().toString(36).slice(2)}`;
    const pat=document.createElementNS("http://www.w3.org/2000/svg","pattern");
    pat.setAttribute("id",patId);pat.setAttribute("patternUnits","userSpaceOnUse");
    pat.setAttribute("x",bbox.x);pat.setAttribute("y",bbox.y);
    pat.setAttribute("width",bbox.width);pat.setAttribute("height",bbox.height);
    const img=document.createElementNS("http://www.w3.org/2000/svg","image");
    img.setAttributeNS("http://www.w3.org/1999/xlink","href",flagUrl);
    img.setAttribute("x",bbox.x);img.setAttribute("y",bbox.y);
    img.setAttribute("width",bbox.width);img.setAttribute("height",bbox.height);
    img.setAttribute("preserveAspectRatio","xMidYMid slice");
    pat.appendChild(img);defs.appendChild(pat);
    groupEl.querySelectorAll("path").forEach(p=>{p.setAttribute("fill",`url(#${patId})`);p.setAttribute("stroke","#111");p.setAttribute("stroke-width","2");});
  }catch(e){console.warn("flag error",e);}
}

// === ê²Œì„ ===
async function nextQuestion(){
  if(round>=TOTAL_QUESTIONS||remainingIds.length===0){finish();return;}
  round++;hintLevel=0;updateBadges();resultEl.textContent="";btnNext.disabled=true;
  const pickId=remainingIds.splice(Math.floor(Math.random()*remainingIds.length),1)[0];
  const rec=allFeatures.find(r=>r.id===pickId);current=rec;
  const others=allFeatures.filter(r=>r.id!==rec.id);const distractors=sample(others,CHOICES_COUNT-1);
  const need=[rec,...distractors];const korNames=await Promise.all(need.map(x=>getKorName(x.nameEng)));korNames.forEach((k,i)=>need[i].nameKor=k);
  const options=shuffle(need).map(x=>({key:x.nameEng,label:x.nameKor||x.nameEng}));
  rec.layer.setStyle({weight:2,color:"#111",fillColor:HIGHLIGHT_COLOR,fillOpacity:.7});map.fitBounds(rec.layer.getBounds().pad(.5));
  await fillWithFlag(rec);
  questionEl.textContent="ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?";renderChoices(options,rec.nameEng);
  hintArea.textContent="íŒíŠ¸: ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œë¡œ ë‚˜ì˜µë‹ˆë‹¤";
}
function renderChoices(options,ans){choicesEl.innerHTML="";options.forEach(opt=>{const b=document.createElement("button");b.className="choice";b.textContent=opt.label;b.onclick=()=>{document.querySelectorAll("button.choice").forEach(x=>x.disabled=true);if(opt.key===ans){score+=10;streak++;setResult(`ì •ë‹µ! âœ… ${opt.label}`,true);}else{streak=0;getKorName(ans).then(k=>setResult(`ì˜¤ë‹µ! âŒ ì •ë‹µì€ ${k}`,false));}updateBadges();btnNext.disabled=false;};choicesEl.appendChild(b);});}
function finish(){questionEl.textContent="ê²Œì„ ì¢…ë£Œ!";choicesEl.innerHTML="";setResult(`ìµœì¢… ì ìˆ˜: ${score} / ${TOTAL_QUESTIONS*10}`,true);btnNext.disabled=true;}
function restart(){score=0;round=0;streak=0;remainingIds=allFeatures.map(r=>r.id);updateBadges();nextQuestion();}

// === íŒíŠ¸ ë²„íŠ¼ ===
btnHint.onclick=async()=>{if(!current)return;const info=await getCountryInfo(current.nameEng);const parts=[];if(hintLevel===0){parts.push("ëŒ€ë¥™: "+(continentKor[info.region]||info.region||"ì •ë³´ì—†ìŒ"));}else if(hintLevel===1){parts.push("ìˆ˜ë„: "+(info.capital||"ì •ë³´ì—†ìŒ"));}else{const key=nameFix[current.nameEng]||current.nameEng;if(foodHints[key])parts.push("ëŒ€í‘œ ìŒì‹: "+foodHints[key]);if(landmarkHints[key])parts.push("ìœ ëª…í•œ ê³³: "+landmarkHints[key]);if(!foodHints[key]&&!landmarkHints[key])parts.push("ì¶”ê°€íŒíŠ¸: êµ­ê¸°ë¥¼ ë³´ì„¸ìš” ğŸ‘€");}hintArea.textContent="íŒíŠ¸: "+parts.join(" | ");hintLevel=(hintLevel+1)%3;};
btnNext.onclick=nextQuestion;btnRestart.onclick=()=>restart();

// === ì‹œì‘ ===
(async function(){initMap();await loadData();restart();})();
</script>
</body>
</html>
