<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸° í€´ì¦ˆ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <style>
    html, body { height:100%; margin:0; font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr auto; }
    header, footer { padding:8px 14px; }
    header { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { background:#eee; border-radius:10px; padding:4px 10px; font-size:12px; }
    #map { width:100%; height:100%; background:#f3f5f8; }
    .panel { display:grid; gap:8px; padding:10px 14px; background:#fafafa; border-top:1px solid #ddd; }
    .question { font-weight:700; }
    .choices { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
    button.choice { padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#fff; }
    button.choice:hover { border-color:#666; }
    .result { min-height:24px; font-weight:600; }
    .controls { display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap; align-items:center; }
    .btn { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .progress { height:8px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background:#1a73e8; transition:width .3s; }
    .tiny { font-size:12px; color:#555; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="badge">ğŸŒ ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸°</div>
    <div class="badge">ë¹Œë“œ v2025-08-30-10</div>
    <div class="badge" id="scoreBadge">ì ìˆ˜ 0</div>
    <div class="badge" id="roundBadge">ë¬¸ì œ 0/10</div>
    <div class="badge" id="streakBadge">ì—°ì†ì •ë‹µ 0</div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div class="question" id="question">ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?</div>
    <div class="choices" id="choices"></div>
    <div class="result" id="result"></div>
    <div class="controls">
      <div class="tiny" id="hintArea">íŒíŠ¸: ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œë¡œ ë‚˜ì˜µë‹ˆë‹¤</div>
      <div>
        <button class="btn" id="btnHint">íŒíŠ¸</button>
        <button class="btn primary" id="btnNext" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
        <button class="btn" id="btnRestart">ì²˜ìŒë¶€í„°</button>
      </div>
    </div>
  </div>

  <footer class="tiny">Â© 2025 êµ­ê°€í€´ì¦ˆ â€” ë² ì´ìŠ¤ë§µ: CARTO, êµ­ê¸°: flagcdn.com, êµ­ê°€ì •ë³´: REST Countries</footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const TOTAL_QUESTIONS = 10;
const CHOICES_COUNT   = 4;
const HIGHLIGHT_COLOR = "#ff5722";
const DEBUG_MODE = false;

/* ===== ì „ì—­ ìƒíƒœ ===== */
let map, countryLayer;
let allFeatures = [];   // {id, nameEng, layer}
let remainingIds = [];
let current = null;
let score = 0, round = 0, streak = 0, hintLevel = 0;

/* ===== UI ===== */
const scoreBadge  = document.getElementById("scoreBadge");
const roundBadge  = document.getElementById("roundBadge");
const streakBadge = document.getElementById("streakBadge");
const progressBar = document.getElementById("progressBar");
const choicesEl   = document.getElementById("choices");
const resultEl    = document.getElementById("result");
const hintArea    = document.getElementById("hintArea");
const btnHint     = document.getElementById("btnHint");
const btnNext     = document.getElementById("btnNext");
const btnRestart  = document.getElementById("btnRestart");
const questionEl  = document.getElementById("question");

/* ===== ë§¤í•‘/ìºì‹œ ===== */
const korCache  = new Map();   // ì˜ë¬¸êµ­ê°€ëª… -> í•œê¸€êµ­ê°€ëª…
const infoCache = new Map();   // ì˜ë¬¸êµ­ê°€ëª… -> { capital, region, cca2 }
const nameFix = {
  // í”í•œ ì´ë¦„ ë¶ˆì¼ì¹˜ êµì •
  "South Korea":"Korea (Republic of)",
  "North Korea":"Korea (Democratic People's Republic of)",
  "USA":"United States",
  "Russia":"Russian Federation",
  "Iran":"Iran (Islamic Republic of)",
  "Vietnam":"Viet Nam",
  "Congo (Kinshasa)":"Democratic Republic of the Congo",
  "Congo (Brazzaville)":"Republic of the Congo",
  "Ivory Coast":"CÃ´te d'Ivoire",
  "Eswatini (Swaziland)":"Eswatini",
  "Syria":"Syrian Arab Republic",
  "Tanzania":"Tanzania, United Republic of",
  "Moldova":"Moldova, Republic of",
  "Vatican":"Holy See",
  "Laos":"Lao People's Democratic Republic",
  "Palestine":"Palestine, State of",
  "Cape Verde":"Cabo Verde",
  "Micronesia":"Micronesia (Federated States of)",
  "TÃ¼rkiye":"Turkey"
};
const overrides = {
  "Korea (Republic of)":"ëŒ€í•œë¯¼êµ­",
  "Korea (Democratic People's Republic of)":"ë¶í•œ",
  "United States":"ë¯¸êµ­","United Kingdom":"ì˜êµ­",
  "Russian Federation":"ëŸ¬ì‹œì•„","China":"ì¤‘êµ­","Japan":"ì¼ë³¸",
  "Germany":"ë…ì¼","France":"í”„ë‘ìŠ¤","Italy":"ì´íƒˆë¦¬ì•„","Spain":"ìŠ¤í˜ì¸",
  "Portugal":"í¬ë¥´íˆ¬ê°ˆ","Netherlands":"ë„¤ëœë€ë“œ","Belgium":"ë²¨ê¸°ì—","Switzerland":"ìŠ¤ìœ„ìŠ¤",
  "Austria":"ì˜¤ìŠ¤íŠ¸ë¦¬ì•„","Czechia":"ì²´ì½”","Poland":"í´ë€ë“œ","Hungary":"í—ê°€ë¦¬",
  "Romania":"ë£¨ë§ˆë‹ˆì•„","Bulgaria":"ë¶ˆê°€ë¦¬ì•„","Greece":"ê·¸ë¦¬ìŠ¤","Turkey":"íŠ€ë¥´í‚¤ì˜ˆ",
  "Ukraine":"ìš°í¬ë¼ì´ë‚˜","Finland":"í•€ë€ë“œ","Norway":"ë…¸ë¥´ì›¨ì´","Sweden":"ìŠ¤ì›¨ë´",
  "Denmark":"ë´ë§ˆí¬","Ireland":"ì•„ì¼ëœë“œ","Canada":"ìºë‚˜ë‹¤","Mexico":"ë©•ì‹œì½”",
  "Brazil":"ë¸Œë¼ì§ˆ","Argentina":"ì•„ë¥´í—¨í‹°ë‚˜","Chile":"ì¹ ë ˆ","Peru":"í˜ë£¨","Colombia":"ì½œë¡¬ë¹„ì•„",
  "Australia":"ì˜¤ìŠ¤íŠ¸ë ˆì¼ë¦¬ì•„","New Zealand":"ë‰´ì§ˆëœë“œ",
  "India":"ì¸ë„","Pakistan":"íŒŒí‚¤ìŠ¤íƒ„","Bangladesh":"ë°©ê¸€ë¼ë°ì‹œ",
  "Indonesia":"ì¸ë„ë„¤ì‹œì•„","Viet Nam":"ë² íŠ¸ë‚¨","Thailand":"íƒœêµ­",
  "Philippines":"í•„ë¦¬í•€","Malaysia":"ë§ë ˆì´ì‹œì•„","Singapore":"ì‹±ê°€í¬ë¥´",
  "Saudi Arabia":"ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„","United Arab Emirates":"ì•„ëì—ë¯¸ë¦¬íŠ¸",
  "Iran (Islamic Republic of)":"ì´ë€","Iraq":"ì´ë¼í¬","Israel":"ì´ìŠ¤ë¼ì—˜",
  "Egypt":"ì´ì§‘íŠ¸","South Africa":"ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­","Morocco":"ëª¨ë¡œì½”",
  "Algeria":"ì•Œì œë¦¬","Ethiopia":"ì—í‹°ì˜¤í”¼ì•„","Nigeria":"ë‚˜ì´ì§€ë¦¬ì•„","Kenya":"ì¼€ëƒ",
  "Democratic Republic of the Congo":"ì½©ê³ ë¯¼ì£¼ê³µí™”êµ­","Republic of the Congo":"ì½©ê³ ê³µí™”êµ­",
  "CÃ´te d'Ivoire":"ì½”íŠ¸ë””ë¶€ì•„ë¥´","Eswatini":"ì—ìŠ¤ì™€í‹°ë‹ˆ"
};
const continentKor = {
  "Africa":"ì•„í”„ë¦¬ì¹´","Americas":"ì•„ë©”ë¦¬ì¹´","Asia":"ì•„ì‹œì•„","Europe":"ìœ ëŸ½","Oceania":"ì˜¤ì„¸ì•„ë‹ˆì•„","Antarctic":"ë‚¨ê·¹"
};
const foodHints = {
  "Korea (Republic of)":"ê¹€ì¹˜, ë¶ˆê³ ê¸°","Japan":"ìŠ¤ì‹œ, ë¼ë©˜","Italy":"í”¼ì, íŒŒìŠ¤íƒ€","France":"ë°”ê²ŒíŠ¸, í¬ë£¨ì•„ìƒ",
  "United States":"í–„ë²„ê±°, í•«ë„ê·¸","China":"ë§Œë‘, í› ê¶ˆ","India":"ì»¤ë¦¬, ë¹„ë¥´ì•¼ë‹ˆ","Brazil":"ìŠˆí•˜ìŠ¤ì½”",
  "Mexico":"íƒ€ì½”, ë¶€ë¦¬ë˜","Thailand":"ë˜ ì–Œê¿, íŒŸíƒ€ì´","Viet Nam":"ìŒ€êµ­ìˆ˜, ë°˜ë¯¸","Turkey":"ì¼€ë°¥",
  "Greece":"ìˆ˜ë¸”ë¼í‚¤","Egypt":"ì½”ìƒ¤ë¦¬","Spain":"ë¹ ì—ì•¼","Germany":"ì†Œì‹œì§€","United Kingdom":"í”¼ì‹œì•¤ì¹©ìŠ¤"
};
const landmarkHints = {
  "France":"ì—í íƒ‘, ë£¨ë¸Œë¥´","Italy":"ì½œë¡œì„¸ì›€, í”¼ì‚¬ì˜ ì‚¬íƒ‘","United Kingdom":"ë¹…ë²¤, ë²„í‚¹ì—„ ê¶ì „",
  "United States":"ììœ ì˜ ì—¬ì‹ ìƒ, ê·¸ëœë“œìºë…„","China":"ë§Œë¦¬ì¥ì„±","Japan":"í›„ì§€ì‚°","India":"íƒ€ì§€ë§ˆí• ",
  "Turkey":"ì•„ì•¼ì†Œí”¼ì•„","Egypt":"í”¼ë¼ë¯¸ë“œ","Brazil":"ë¦¬ìš° ì˜ˆìˆ˜ìƒ","Spain":"ì‚¬ê·¸ë¼ë‹¤ íŒŒë°€ë¦¬ì•„"
};

/* ===== ìœ í‹¸ ===== */
const shuffle = arr => arr.sort(() => Math.random() - 0.5);
const sample  = (arr, n) => shuffle(arr.slice()).slice(0, n);
const debug   = msg => { if (DEBUG_MODE) { console.log("[DEBUG]", msg); hintArea.textContent = "DEBUG: " + msg; } };

function updateBadges(){
  scoreBadge.textContent = `ì ìˆ˜ ${score}`;
  roundBadge.textContent = `ë¬¸ì œ ${round}/${TOTAL_QUESTIONS}`;
  streakBadge.textContent = `ì—°ì†ì •ë‹µ ${streak}`;
  progressBar.style.width = `${(round/TOTAL_QUESTIONS)*100}%`;
}
function setResult(text, ok){
  resultEl.textContent = text;
  resultEl.style.color = ok ? "#0a7d2b" : "#c62828";
}

/* ===== REST Countries ===== */
async function queryCountry(nameEng){
  const q = nameFix[nameEng] || nameEng;
  let url = `https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fullText=true&fields=name,translations,capital,region,cca2`;
  let res = await fetch(url);
  if (!res.ok) {
    url = `https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fields=name,translations,capital,region,cca2`;
    res = await fetch(url);
  }
  if (res.ok) {
    const data = await res.json();
    return Array.isArray(data) ? data[0] : null;
  } else {
    debug("REST not ok: " + q);
  }
  return null;
}
async function getKorName(nameEng){
  if (korCache.has(nameEng)) return korCache.get(nameEng);
  if (overrides[nameEng]) { korCache.set(nameEng, overrides[nameEng]); return overrides[nameEng]; }
  const hit = await queryCountry(nameEng);
  const kor = hit?.translations?.kor?.common || hit?.translations?.kor?.official || hit?.name?.common || nameEng;
  korCache.set(nameEng, kor);
  return kor;
}
async function getCountryInfo(nameEng){
  if (infoCache.has(nameEng)) return infoCache.get(nameEng);
  const hit = await queryCountry(nameEng);
  const out = {
    capital: Array.isArray(hit?.capital) ? hit.capital[0] : (hit?.capital || null),
    region: hit?.region || null,
    cca2: hit?.cca2 || null
  };
  infoCache.set(nameEng, out);
  return out;
}

/* ===== ì§€ë„ ===== */
const defaultStyle   = { weight: .9, color:"#8a8a8a", fillColor:"#dfe7ef", fillOpacity:.82 };
const highlightStyle = { weight: 2,  color:"#111",   fillColor: HIGHLIGHT_COLOR, fillOpacity:.7 };

function initMap(){
  map = L.map("map", { renderer: L.svg(), zoomSnap: .1, minZoom: 1.5 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19
  }).addTo(map);
  map.setView([20,0], 2);
}

async function loadData(){
  const topo = await fetch("https://unpkg.com/world-atlas@2/countries-110m.json").then(r=>r.json());
  const geo  = topojson.feature(topo, topo.objects.countries);

  countryLayer = L.geoJSON(geo, {
    style: defaultStyle,
    onEachFeature: (f, l) => {
      // ì´ë¦„ì„ ì–´ë–¤ í•„ë“œì—ì„œë“  ì•ˆì •ì ìœ¼ë¡œ ì±„ì·¨
      const name = f.properties?.name || f.properties?.name_long || f.properties?.admin;
      if (!name) return;
      allFeatures.push({ id: String(f.id ?? f.properties?.id ?? ""), nameEng: name, layer: l });
    }
  }).addTo(map);

  // ë‚¨ê·¹ ë“± ì œê±°
  allFeatures = allFeatures.filter(r => r.nameEng && !/antarctica/i.test(r.nameEng));
  remainingIds = allFeatures.map(r => r.id);
  debug("countries loaded: " + allFeatures.length);
}

/* ===== êµ­ê¸° ì±„ìš°ê¸°: clipPath ë°©ì‹ (CORS ì•ˆì „, ì•ˆì •ì ) ===== */
function waitForPaths(rec){
  return new Promise(resolve=>{
    const poll = ()=>{
      const el = rec.layer.getElement?.();
      const paths = el?.querySelectorAll?.('path');
      if (el && paths && paths.length) resolve({ groupEl: el, paths });
      else requestAnimationFrame(poll);
    };
    poll();
  });
}
function clearFlagGraphics(){
  const svg = map.getPane('overlayPane')?.querySelector('svg');
  if (!svg) return;
  svg.querySelectorAll('[data-flagimg="1"]').forEach(n => n.remove());
  svg.querySelectorAll('[data-flagclip="1"]').forEach(n => n.remove());
}
async function urlToDataUrl(url){
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("flag fetch fail " + url);
  const blob = await resp.blob();
  return await new Promise(res => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(blob); });
}
async function fillWithFlag(rec){
  try{
    const info = await getCountryInfo(rec.nameEng);
    const code = info?.cca2?.toLowerCase();
    if (!code) { debug("no cca2"); return; }
    const flagUrl = `https://flagcdn.com/w320/${code}.png`;

    // ì´ë¯¸ì§€ ì¡´ì¬ ì²´í¬(HEAD) â†’ ì‹¤íŒ¨ì‹œ ë§ˆì»¤ í´ë°±
    const head = await fetch(flagUrl, { method: 'HEAD' });
    if (!head.ok) { debug("flag 404: "+flagUrl); return; }

    const { groupEl } = await waitForPaths(rec);
    const svg = map.getPane('overlayPane').querySelector('svg');
    if (!svg) { debug("no svg"); return; }
    let defs = svg.querySelector('defs');
    if (!defs) { defs = document.createElementNS('http://www.w3.org/2000/svg','defs'); svg.prepend(defs); }

    const bbox = groupEl.getBBox();
    if (bbox.width === 0 || bbox.height === 0) { debug("bbox 0"); return; }

    clearFlagGraphics(); // ì´ì „ ë¬¸ì œ ì”ì¬ ì œê±°

    // clipPath ë§Œë“¤ê¸° (pathë“¤ì„ ë³µì œ)
    const clipId = 'flagclip-' + Math.random().toString(36).slice(2);
    const clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
    clip.setAttribute('id', clipId);
    clip.setAttribute('clipPathUnits','userSpaceOnUse');
    clip.setAttribute('data-flagclip','1');

    groupEl.querySelectorAll('path').forEach(p => {
      const c = p.cloneNode(true);
      // fill/stroke ì†ì„± ì œê±°í•´ë„ clipì—ëŠ” ì˜í–¥ ì—†ìŒ
      c.removeAttribute('fill'); c.removeAttribute('stroke'); c.removeAttribute('stroke-width');
      clip.appendChild(c);
    });
    defs.appendChild(clip);

    // flag ì´ë¯¸ì§€ë¥¼ dataURLë¡œ ë°”ê¿” CORS ì•ˆì „í•˜ê²Œ ì£¼ì…
    const dataUrl = await urlToDataUrl(flagUrl);

    const img = document.createElementNS('http://www.w3.org/2000/svg','image');
    img.setAttributeNS('http://www.w3.org/1999/xlink','href', dataUrl);
    img.setAttribute('x', bbox.x);
    img.setAttribute('y', bbox.y);
    img.setAttribute('width', bbox.width);
    img.setAttribute('height', bbox.height);
    img.setAttribute('preserveAspectRatio','xMidYMid slice');
    img.setAttribute('clip-path', `url(#${clipId})`);
    img.setAttribute('data-flagimg','1');

    // ê²½ê³„ì„ ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ì´ë¯¸ì§€ ìš”ì†ŒëŠ” group ì•ì— ë„£ê¸°
    svg.insertBefore(img, groupEl);

    // ê²½ê³„ì„  ê°•ì¡°, ë‚´ë¶€ ì±„ì›€ì€ íˆ¬ëª…ìœ¼ë¡œ (ì´ë¯¸ì§€ê°€ ì±„ì›Œì¤Œ)
    rec.layer.setStyle({ weight: 2, color: "#111", fillOpacity: 0.001 });
  }catch(e){
    debug("flag error " + (e && e.message ? e.message : e));
  }
}

/* ===== ê²Œì„ í”Œë¡œìš° ===== */
function resetStyles(){ if (countryLayer) countryLayer.setStyle(defaultStyle); }
function fitAndHighlight(rec){
  resetStyles();
  clearFlagGraphics();
  rec.layer.setStyle(highlightStyle);
  try {
    const b = rec.layer.getBounds();
    map.fitBounds(b.pad(0.5), { animate:true, duration:0.6 });
    rec.layer.bringToFront();
  } catch (e) {
    map.setView([20,0],2);
  }
}

async function nextQuestion(){
  if (round >= TOTAL_QUESTIONS || remainingIds.length === 0) { finish(); return; }
  round++; hintLevel = 0;
  updateBadges(); resultEl.textContent = ""; btnNext.disabled = true;

  // ì •ë‹µ ì„ íƒ
  const pickId = remainingIds.splice(Math.floor(Math.random()*remainingIds.length), 1)[0];
  const rec = allFeatures.find(r => r.id === pickId);
  current = rec;

  // ì˜¤ë‹µ êµ¬ì„± (ìµœì†Œ ê°œìˆ˜ ë³´ì¥)
  const others = allFeatures.filter(r => r.id !== rec.id);
  let distractors = sample(others, CHOICES_COUNT - 1);
  if (distractors.length < CHOICES_COUNT - 1) {
    distractors = others.slice(0, CHOICES_COUNT - 1);
  }

  // í•œê¸€ ë³´ê¸° ë³€í™˜
  const need = [rec, ...distractors];
  const korNames = await Promise.all(need.map(x => getKorName(x.nameEng)));
  korNames.forEach((k, i) => need[i].nameKor = k);
  const options = shuffle(need).map(x => ({ key: x.nameEng, label: x.nameKor || x.nameEng }));

  // ì§€ë„ ì—°ì¶œ + êµ­ê¸° ì±„ìš°ê¸°
  fitAndHighlight(rec);
  await fillWithFlag(rec);

  questionEl.textContent = "ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?";
  renderChoices(options, rec.nameEng);

  hintArea.textContent = "íŒíŠ¸: ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œë¡œ ë‚˜ì˜µë‹ˆë‹¤";
  debug("ì •ë‹µ: " + rec.nameEng + " / ì˜¤ë‹µ: " + distractors.map(d=>d.nameEng).join(", "));
}

function renderChoices(options, answerKeyEng){
  choicesEl.innerHTML = "";
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = opt.label;
    btn.onclick = () => {
      document.querySelectorAll("button.choice").forEach(x => x.disabled = true);
      const correct = (opt.key === answerKeyEng);
      if (correct) { score += 10; streak += 1; setResult(`ì •ë‹µ! âœ… ${opt.label}`, true); }
      else { streak = 0; getKorName(answerKeyEng).then(k => setResult(`ì˜¤ë‹µ! âŒ ì •ë‹µì€ ${k}`, false)); }
      updateBadges(); btnNext.disabled = false;
    };
    choicesEl.appendChild(btn);
  });
}

function finish(){
  resetStyles(); clearFlagGraphics(); map.setView([20,0],2);
  questionEl.textContent = "ê²Œì„ ì¢…ë£Œ!";
  choicesEl.innerHTML = "";
  setResult(`ìµœì¢… ì ìˆ˜: ${score} / ${TOTAL_QUESTIONS*10}`, true);
  btnNext.disabled = true;
}

function restart(){
  score = 0; round = 0; streak = 0;
  remainingIds = allFeatures.map(r => r.id);
  updateBadges();
  nextQuestion();
}

/* ===== íŒíŠ¸ (ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ) ===== */
btnHint.onclick = async () => {
  if (!current) return;
  const info = await getCountryInfo(current.nameEng);
  const parts = [];
  if (hintLevel === 0) {
    parts.push("ëŒ€ë¥™: " + (continentKor[info.region] || info.region || "ì •ë³´ ì—†ìŒ"));
  } else if (hintLevel === 1) {
    parts.push("ìˆ˜ë„: " + (info.capital || "ì •ë³´ ì—†ìŒ"));
  } else {
    const key = nameFix[current.nameEng] || current.nameEng;
    const foods = foodHints[key];
    const spots = landmarkHints[key];
    if (foods) parts.push("ëŒ€í‘œ ìŒì‹: " + foods);
    if (spots) parts.push("ìœ ëª…í•œ ê³³: " + spots);
    if (!foods && !spots) parts.push("ì¶”ê°€ íŒíŠ¸: êµ­ê¸°ë¥¼ ìœ ì‹¬íˆ ë³´ì„¸ìš” ğŸ‘€");
  }
  hintArea.textContent = "íŒíŠ¸: " + parts.join(" | ");
  hintLevel = (hintLevel + 1) % 3;
};

/* ===== ë²„íŠ¼ ===== */
btnNext.onclick = nextQuestion;
btnRestart.onclick = () => restart();

/* ===== ì‹œì‘ ===== */
(async function(){
  initMap();
  // topojson ì „ì—­ ë³´ì¥ (ì¼ë¶€ í™˜ê²½ì—ì„œ ëŠ¦ê²Œ ë¡œë“œë  ìˆ˜ ìˆì–´ ì²´í¬)
  if (typeof topojson === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://unpkg.com/topojson-client@3';
    document.head.appendChild(s);
    await new Promise(r => s.onload = r);
  }
  await loadData();
  restart();
})();
</script>
</body>
</html>
