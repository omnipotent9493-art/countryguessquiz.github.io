<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸° í€´ì¦ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body {height:100%;margin:0;font-family:"Noto Sans KR",sans-serif;}
    #app {height:100%;display:grid;grid-template-rows:auto 1fr auto;}
    header,footer {padding:8px 14px;}
    header {display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .badge {background:#eee;border-radius:10px;padding:4px 10px;font-size:12px;}
    #map {width:100%;height:100%;}
    .panel {display:grid;gap:8px;padding:10px 14px;background:#fafafa;border-top:1px solid #ddd;}
    .question {font-weight:700;}
    .choices {display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));}
    button.choice {padding:10px;border:1px solid #ccc;border-radius:8px;cursor:pointer;background:#fff;}
    button.choice:hover {border-color:#666;}
    .result {min-height:24px;font-weight:600;}
    .controls {display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap;align-items:center;}
    .btn {padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;font-weight:600;}
    .btn.primary {background:#1a73e8;color:#fff;border-color:#1a73e8;}
    .progress {height:8px;background:#eee;border-radius:999px;overflow:hidden;}
    .bar {height:100%;width:0;background:#1a73e8;transition:width .3s;}
    .tiny {font-size:12px;color:#555;}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="badge">ğŸŒ ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸°</div>
    <div class="badge">ë¹Œë“œ v2025-08-30-noLabels</div>
    <div class="badge" id="scoreBadge">ì ìˆ˜ 0</div>
    <div class="badge" id="roundBadge">ë¬¸ì œ 0/10</div>
    <div class="badge" id="streakBadge">ì—°ì†ì •ë‹µ 0</div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div class="question" id="question">ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?</div>
    <div class="choices" id="choices"></div>
    <div class="result" id="result"></div>
    <div class="controls">
      <div class="tiny" id="hintArea">íŒíŠ¸: ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œë¡œ ë‚˜ì˜µë‹ˆë‹¤</div>
      <div>
        <button class="btn" id="btnHint">íŒíŠ¸</button>
        <button class="btn primary" id="btnNext" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
        <button class="btn" id="btnRestart">ì²˜ìŒë¶€í„°</button>
      </div>
    </div>
  </div>

  <footer class="tiny">Â©2025 êµ­ê°€í€´ì¦ˆ â€” ì§€ë„: OpenStreetMap, êµ­ê°€ì •ë³´: REST Countries</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

<script>
const TOTAL_QUESTIONS=10,CHOICES_COUNT=4,HIGHLIGHT_COLOR="#ff5722";
let map,countryLayer,allFeatures=[],remainingIds=[],current=null,score=0,round=0,streak=0,hintLevel=0;

// UI
const scoreBadge=document.getElementById("scoreBadge"),roundBadge=document.getElementById("roundBadge"),streakBadge=document.getElementById("streakBadge"),progressBar=document.getElementById("progressBar"),choicesEl=document.getElementById("choices"),resultEl=document.getElementById("result"),hintArea=document.getElementById("hintArea"),btnHint=document.getElementById("btnHint"),btnNext=document.getElementById("btnNext"),btnRestart=document.getElementById("btnRestart"),questionEl=document.getElementById("question");

// ìºì‹œ
const korCache=new Map(),infoCache=new Map();
const overrides={"Korea (Republic of)":"ëŒ€í•œë¯¼êµ­","Korea (Democratic People's Republic of)":"ë¶í•œ","United States":"ë¯¸êµ­","United Kingdom":"ì˜êµ­","Russian Federation":"ëŸ¬ì‹œì•„","China":"ì¤‘êµ­","Japan":"ì¼ë³¸","Germany":"ë…ì¼","France":"í”„ë‘ìŠ¤","Italy":"ì´íƒˆë¦¬ì•„","Brazil":"ë¸Œë¼ì§ˆ","Mexico":"ë©•ì‹œì½”"};
const continentKor={"Africa":"ì•„í”„ë¦¬ì¹´","Americas":"ì•„ë©”ë¦¬ì¹´","Asia":"ì•„ì‹œì•„","Europe":"ìœ ëŸ½","Oceania":"ì˜¤ì„¸ì•„ë‹ˆì•„"};
const foodHints={"Korea (Republic of)":"ê¹€ì¹˜, ë¶ˆê³ ê¸°","Japan":"ìŠ¤ì‹œ, ë¼ë©˜","Italy":"í”¼ì, íŒŒìŠ¤íƒ€","France":"ë°”ê²ŒíŠ¸, í¬ë£¨ì•„ìƒ","United States":"í–„ë²„ê±°, í•«ë„ê·¸","China":"ë§Œë‘, í› ê¶ˆ","India":"ì»¤ë¦¬, ë¹„ë¥´ì•¼ë‹ˆ","Brazil":"ìŠˆí•˜ìŠ¤ì½”","Mexico":"íƒ€ì½”, ë¶€ë¦¬ë˜"};

// ìœ í‹¸
const shuffle=a=>a.sort(()=>Math.random()-.5),sample=(a,n)=>shuffle(a.slice()).slice(0,n);
function updateBadges(){scoreBadge.textContent=`ì ìˆ˜ ${score}`;roundBadge.textContent=`ë¬¸ì œ ${round}/${TOTAL_QUESTIONS}`;streakBadge.textContent=`ì—°ì†ì •ë‹µ ${streak}`;progressBar.style.width=`${(round/TOTAL_QUESTIONS)*100}%`;}
function setResult(t,ok){resultEl.textContent=t;resultEl.style.color=ok?"#0a7d2b":"#c62828";}

// REST Countries
async function queryCountry(nameEng){try{const res=await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(nameEng)}?fullText=true&fields=name,translations,capital,region`);if(res.ok){const d=await res.json();return Array.isArray(d)?d[0]:null}}catch{}return null;}
async function getKorName(nameEng){if(korCache.has(nameEng))return korCache.get(nameEng);if(overrides[nameEng]){korCache.set(nameEng,overrides[nameEng]);return overrides[nameEng];}const hit=await queryCountry(nameEng);const kor=hit?.translations?.kor?.common||hit?.translations?.kor?.official||hit?.name?.common||nameEng;korCache.set(nameEng,kor);return kor;}
async function getCountryInfo(nameEng){if(infoCache.has(nameEng))return infoCache.get(nameEng);const hit=await queryCountry(nameEng);const out={capital:Array.isArray(hit?.capital)?hit.capital[0]:hit?.capital||null,region:hit?.region||null};infoCache.set(nameEng,out);return out;}

// ì§€ë„
function initMap(){map=L.map("map",{renderer:L.svg(),zoomSnap:.1,minZoom:1.5});L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"&copy; OSM"}).addTo(map);map.setView([20,0],2);}
async function loadData(){const topo=await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r=>r.json());const geo=topojson.feature(topo,topo.objects.countries);countryLayer=L.geoJSON(geo,{style:{weight:.8,color:"#888",fillColor:"#dfe7ef",fillOpacity:.8},onEachFeature:(f,l)=>{const name=f.properties?.name||f.properties?.admin;if(!name)return;allFeatures.push({id:String(f.id),nameEng:name,layer:l});}}).addTo(map);allFeatures=allFeatures.filter(r=>r.nameEng&&!/antarctica/i.test(r.nameEng));remainingIds=allFeatures.map(r=>r.id);}

// ê²Œì„
function resetStyles(){if(countryLayer)countryLayer.setStyle({weight:.8,color:"#888",fillColor:"#dfe7ef",fillOpacity:.8});}
function fitAndHighlight(rec){resetStyles();rec.layer.setStyle({weight:2,color:"#111",fillColor:HIGHLIGHT_COLOR,fillOpacity:.7});try{map.fitBounds(rec.layer.getBounds().pad(0.5));rec.layer.bringToFront();}catch{map.setView([20,0],2);}}
async function nextQuestion(){if(round>=TOTAL_QUESTIONS||remainingIds.length===0){finish();return;}round++;hintLevel=0;updateBadges();resultEl.textContent="";btnNext.disabled=true;const pickId=remainingIds.splice(Math.floor(Math.random()*remainingIds.length),1)[0];const rec=allFeatures.find(r=>r.id===pickId);current=rec;const others=allFeatures.filter(r=>r.id!==rec.id);let distractors=sample(others,CHOICES_COUNT-1);if(distractors.length<CHOICES_COUNT-1)distractors=others.slice(0,CHOICES_COUNT-1);const need=[rec,...distractors];const korNames=await Promise.all(need.map(x=>getKorName(x.nameEng)));korNames.forEach((k,i)=>need[i].nameKor=k);const options=shuffle(need).map(x=>({key:x.nameEng,label:x.nameKor||x.nameEng}));fitAndHighlight(rec);questionEl.textContent="ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?";renderChoices(options,rec.nameEng);hintArea.textContent="íŒíŠ¸: ëŒ€ë¥™ â†’ ìˆ˜ë„ â†’ ìŒì‹/ëª…ì†Œ ìˆœì„œ";}

function renderChoices(options,ans){choicesEl.innerHTML="";options.forEach(opt=>{const b=document.createElement("button");b.className="choice";b.textContent=opt.label;b.onclick=()=>{document.querySelectorAll("button.choice").forEach(x=>x.disabled=true);if(opt.key===ans){score+=10;streak++;setResult(`ì •ë‹µ! âœ… ${opt.label}`,true);}else{streak=0;getKorName(ans).then(k=>setResult(`ì˜¤ë‹µ! âŒ ì •ë‹µì€ ${k}`,false));}updateBadges();btnNext.disabled=false;};choicesEl.appendChild(b);});}
function finish(){resetStyles();map.setView([20,0],2);questionEl.textContent="ê²Œì„ ì¢…ë£Œ!";choicesEl.innerHTML="";setResult(`ìµœì¢… ì ìˆ˜: ${score} / ${TOTAL_QUESTIONS*10}`,true);btnNext.disabled=true;}
function restart(){score=0;round=0;streak=0;remainingIds=allFeatures.map(r=>r.id);updateBadges();nextQuestion();}

// íŒíŠ¸
btnHint.onclick=async()=>{if(!current)return;const info=await getCountryInfo(current.nameEng);const parts=[];if(hintLevel===0){parts.push("ëŒ€ë¥™: "+(continentKor[info.region]||info.region||"ì •ë³´ì—†ìŒ"));}else if(hintLevel===1){parts.push("ìˆ˜ë„: "+(info.capital||"ì •ë³´ì—†ìŒ"));}else{const key=current.nameEng;if(foodHints[key])parts.push("ëŒ€í‘œ ìŒì‹: "+foodHints[key]);}hintArea.textContent="íŒíŠ¸: "+parts.join(" | ");hintLevel=(hintLevel+1)%3;};
btnNext.onclick=nextQuestion;btnRestart.onclick=()=>restart();

// ì‹œì‘
(async function(){initMap();await loadData();restart();})();
</script>
</body>
</html>
