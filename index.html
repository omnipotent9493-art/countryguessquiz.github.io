<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸° í€´ì¦ˆ</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr auto; }
    header, footer { padding: 10px 14px; }
    header { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .badge { background: #eee; border-radius: 10px; padding: 4px 10px; font-size: 12px; }
    #map { width: 100%; height: 100%; }
    .panel { display: grid; gap: 8px; padding: 10px 14px; background: #fafafa; border-top: 1px solid #eaeaea; }
    .question { font-weight: 700; }
    .choices { display: grid; gap: 8px; grid-template-columns: repeat(2,minmax(0,1fr)); }
    button.choice {
      padding: 10px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; font-size: 15px; background: white;
    }
    button.choice:hover { border-color: #aaa; }
    .result { min-height: 24px; font-weight: 600; }
    .controls { display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .btn {
      padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .progress { height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #1a73e8; transition: width .3s; }
    .tiny { font-size: 12px; color: #666; }
    @media (max-width: 640px) { .choices { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="badge">ğŸŒ ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸°</div>
      <div class="badge" id="scoreBadge">ì ìˆ˜ 0</div>
      <div class="badge" id="roundBadge">ë¬¸ì œ 0 / 10</div>
      <div class="badge" id="streakBadge">ì—°ì†ì •ë‹µ 0</div>
    </header>

    <div id="map"></div>

    <div class="panel">
      <div class="progress"><div class="bar" id="progressBar"></div></div>
      <div class="question" id="question">ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?</div>
      <div class="choices" id="choices"></div>
      <div class="result" id="result"></div>
      <div class="controls">
        <div class="tiny" id="hintArea">íŒíŠ¸: ëŒ€ë¥™ íŒíŠ¸ ë³´ì´ê¸° ğŸ”</div>
        <div>
          <button class="btn" id="btnHint">íŒíŠ¸</button>
          <button class="btn primary" id="btnNext" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
          <button class="btn" id="btnRestart">ì²˜ìŒë¶€í„°</button>
        </div>
      </div>
    </div>

    <footer class="tiny">
      íŒ: ì •ë‹µì„ ê³ ë¥´ë©´ ì§€ë„ì— **ê°•ì¡°**ê°€ ìœ ì§€ë˜ê³ , â€œë‹¤ìŒ ë¬¸ì œâ€ë¥¼ ëˆ„ë¥´ë©´ ìƒˆ êµ­ê°€ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.
    </footer>
  </div>

  <!-- Leaflet & TopoJSON -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <script>
  // ====== ì„¤ì •ê°’ ======
  const TOTAL_QUESTIONS = 10;      // í•œ íŒì— ë‚¼ ë¬¸ì œ ìˆ˜
  const CHOICES_COUNT   = 4;       // ë³´ê¸° ê°œìˆ˜
  const HIGHLIGHT_COLOR = "#ff5722";

  // ====== í•œê¸€ ë²ˆì—­ ìºì‹œ & ì˜¤ë²„ë¼ì´ë“œ ======
  const korCache = new Map(); // nameEng -> nameKor
  const overrides = {
    "South Korea": "ëŒ€í•œë¯¼êµ­",
    "North Korea": "ë¶í•œ",
    "United States of America": "ë¯¸êµ­",
    "United States": "ë¯¸êµ­",
    "United Kingdom": "ì˜êµ­",
    "Russia": "ëŸ¬ì‹œì•„",
    "Russian Federation": "ëŸ¬ì‹œì•„",
    "China": "ì¤‘êµ­",
    "Japan": "ì¼ë³¸",
    "Germany": "ë…ì¼",
    "France": "í”„ë‘ìŠ¤",
    "Italy": "ì´íƒˆë¦¬ì•„",
    "Spain": "ìŠ¤í˜ì¸",
    "Portugal": "í¬ë¥´íˆ¬ê°ˆ",
    "Netherlands": "ë„¤ëœë€ë“œ",
    "Belgium": "ë²¨ê¸°ì—",
    "Switzerland": "ìŠ¤ìœ„ìŠ¤",
    "Austria": "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„",
    "Czechia": "ì²´ì½”",
    "Poland": "í´ë€ë“œ",
    "Hungary": "í—ê°€ë¦¬",
    "Romania": "ë£¨ë§ˆë‹ˆì•„",
    "Bulgaria": "ë¶ˆê°€ë¦¬ì•„",
    "Greece": "ê·¸ë¦¬ìŠ¤",
    "Turkey": "íŠ€ë¥´í‚¤ì˜ˆ",
    "Ukraine": "ìš°í¬ë¼ì´ë‚˜",
    "Finland": "í•€ë€ë“œ",
    "Norway": "ë…¸ë¥´ì›¨ì´",
    "Sweden": "ìŠ¤ì›¨ë´",
    "Denmark": "ë´ë§ˆí¬",
    "Ireland": "ì•„ì¼ëœë“œ",
    "Canada": "ìºë‚˜ë‹¤",
    "Mexico": "ë©•ì‹œì½”",
    "Brazil": "ë¸Œë¼ì§ˆ",
    "Argentina": "ì•„ë¥´í—¨í‹°ë‚˜",
    "Chile": "ì¹ ë ˆ",
    "Peru": "í˜ë£¨",
    "Colombia": "ì½œë¡¬ë¹„ì•„",
    "Australia": "ì˜¤ìŠ¤íŠ¸ë ˆì¼ë¦¬ì•„",
    "New Zealand": "ë‰´ì§ˆëœë“œ",
    "India": "ì¸ë„",
    "Pakistan": "íŒŒí‚¤ìŠ¤íƒ„",
    "Bangladesh": "ë°©ê¸€ë¼ë°ì‹œ",
    "Indonesia": "ì¸ë„ë„¤ì‹œì•„",
    "Vietnam": "ë² íŠ¸ë‚¨",
    "Thailand": "íƒœêµ­",
    "Philippines": "í•„ë¦¬í•€",
    "Malaysia": "ë§ë ˆì´ì‹œì•„",
    "Singapore": "ì‹±ê°€í¬ë¥´",
    "Saudi Arabia": "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„",
    "United Arab Emirates": "ì•„ëì—ë¯¸ë¦¬íŠ¸",
    "Iran": "ì´ë€",
    "Iraq": "ì´ë¼í¬",
    "Israel": "ì´ìŠ¤ë¼ì—˜",
    "Egypt": "ì´ì§‘íŠ¸",
    "South Africa": "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­",
    "Morocco": "ëª¨ë¡œì½”",
    "Algeria": "ì•Œì œë¦¬",
    "Ethiopia": "ì—í‹°ì˜¤í”¼ì•„",
    "Nigeria": "ë‚˜ì´ì§€ë¦¬ì•„",
    "Kenya": "ì¼€ëƒ",
  };

  const continentKor = {
    "Africa": "ì•„í”„ë¦¬ì¹´",
    "Asia": "ì•„ì‹œì•„",
    "Europe": "ìœ ëŸ½",
    "Oceania": "ì˜¤ì„¸ì•„ë‹ˆì•„",
    "North America": "ë¶ì•„ë©”ë¦¬ì¹´",
    "South America": "ë‚¨ì•„ë©”ë¦¬ì¹´",
    "Antarctica": "ë‚¨ê·¹"
  };

  async function getKorName(nameEng) {
    if (!nameEng) return null;
    if (korCache.has(nameEng)) return korCache.get(nameEng);
    if (overrides[nameEng]) {
      korCache.set(nameEng, overrides[nameEng]);
      return overrides[nameEng];
    }
    // REST Countriesë¡œ ì‹œë„ (CORS í—ˆìš©ë¨)
    try {
      // 1) fullText ìš°ì„ 
      let url = `https://restcountries.com/v3.1/name/${encodeURIComponent(nameEng)}?fullText=true&fields=name,translations`;
      let res = await fetch(url);
      if (!res.ok) {
        // 2) ë¶€ë¶„ ë§¤ì¹­ fallback
        url = `https://restcountries.com/v3.1/name/${encodeURIComponent(nameEng)}?fields=name,translations`;
        res = await fetch(url);
      }
      if (res.ok) {
        const data = await res.json();
        const hit = Array.isArray(data) ? data.find(d => d?.name?.common) : null;
        const kor = hit?.translations?.kor?.common
          || hit?.translations?.kor?.official
          || overrides[nameEng]
          || hit?.name?.common;
        if (kor) {
          korCache.set(nameEng, kor);
          return kor;
        }
      }
    } catch (e) {
      // ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œí•˜ê³  ì˜ë¬¸ ìœ ì§€
    }
    korCache.set(nameEng, nameEng); // ë§ˆì§€ë§‰ fallback
    return nameEng;
  }

  // ====== ì „ì—­ ìƒíƒœ ======
  let map, countryLayer;
  let allFeatures = [];            // {id, nameEng, nameKor, continent, layer}
  let remainingIds = [];
  let current = null;
  let score = 0, round = 0, streak = 0;

  // ====== UI ì°¸ì¡° ======
  const scoreBadge   = document.getElementById("scoreBadge");
  const roundBadge   = document.getElementById("roundBadge");
  const streakBadge  = document.getElementById("streakBadge");
  const progressBar  = document.getElementById("progressBar");
  const choicesEl    = document.getElementById("choices");
  const resultEl     = document.getElementById("result");
  const hintArea     = document.getElementById("hintArea");
  const btnHint      = document.getElementById("btnHint");
  const btnNext      = document.getElementById("btnNext");
  const btnRestart   = document.getElementById("btnRestart");
  const questionEl   = document.getElementById("question");

  // ====== ìœ í‹¸ ======
  const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
  const sample  = (arr, n) => shuffle(arr.slice()).slice(0, n);

  function updateBadges() {
    scoreBadge.textContent  = `ì ìˆ˜ ${score}`;
    roundBadge.textContent  = `ë¬¸ì œ ${round} / ${TOTAL_QUESTIONS}`;
    streakBadge.textContent = `ì—°ì†ì •ë‹µ ${streak}`;
    progressBar.style.width = `${(round / TOTAL_QUESTIONS) * 100}%`;
  }

  function setResult(text, ok) {
    resultEl.textContent = text;
    resultEl.style.color = ok ? "#0a7d2b" : "#c62828";
  }

  function resetStyles() {
    if (countryLayer) countryLayer.setStyle(defaultStyle);
  }

  // ====== ì§€ë„ ì´ˆê¸°í™” ======
  const defaultStyle = { weight: 0.7, color: "#999", fillColor: "#dfe7ef", fillOpacity: 0.7 };
  const highlightStyle = { weight: 2, color: "#111", fillColor: HIGHLIGHT_COLOR, fillOpacity: 0.7 };

  function initMap() {
    map = L.map("map", { zoomSnap: 0.1, worldCopyJump: false, minZoom: 1.5 });
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
    map.setView([20, 0], 2);
  }

  async function loadData() {
    const topo = await fetch("https://unpkg.com/world-atlas@2/countries-110m.json").then(r => r.json());
    const geo  = topojson.feature(topo, topo.objects.countries);

    let idToName = {};
    try {
      const names = await fetch("https://unpkg.com/world-atlas@2/world/110m.json").then(r => r.json());
      if (names.countries && Array.isArray(names.countries)) {
        names.countries.forEach(c => { if (c.id != null && c.name) idToName[String(c.id)] = c.name; });
      }
    } catch(e) {}

    countryLayer = L.geoJSON(geo, {
      style: defaultStyle,
      onEachFeature: (feature, layer) => {
        const id   = String(feature.id ?? (feature.properties && feature.properties.id) ?? "");
        const name = feature.properties && (feature.properties.name || feature.properties.name_long || feature.properties.admin);
        const finalName = name || idToName[id] || null;
        if (!finalName) return;
        const rec = {
          id,
          nameEng: finalName,
          nameKor: null, // ë‚˜ì¤‘ì— ì±„ìš¸ ê²ƒ
          continent: feature.properties && (feature.properties.continent || feature.properties.region_un || ""),
          feature,
          layer
        };
        allFeatures.push(rec);
      }
    }).addTo(map);

    allFeatures = allFeatures.filter(r =>
      r.nameEng && !/antarctica/i.test(r.nameEng) && r.nameEng.length >= 3
    );

    remainingIds = allFeatures.map(r => r.id);
  }

  function fitAndHighlight(rec) {
    resetStyles();
    rec.layer.setStyle(highlightStyle);
    try {
      const bounds = rec.layer.getBounds();
      map.fitBounds(bounds.pad(0.5), { animate: true, duration: 0.6 });
    } catch (e) {
      map.setView([20, 0], 2);
    }
  }

  async function nextQuestion() {
    if (round >= TOTAL_QUESTIONS || remainingIds.length === 0) {
      finish();
      return;
    }
    round++;
    updateBadges();
    resultEl.textContent = "";
    btnNext.disabled = true;

    const pickId = remainingIds.splice(Math.floor(Math.random() * remainingIds.length), 1)[0];
    const rec = allFeatures.find(r => r.id === pickId);
    current = rec;

    // ë³´ê¸° êµ¬ì„±: ì •ë‹µ + ì˜¤ë‹µ
    const others = allFeatures.filter(r => r.id !== rec.id);
    const distractors = sample(others, CHOICES_COUNT - 1);

    // í•„ìš”í•œ ì˜ë¬¸ ì´ë¦„ë“¤ â†’ í•œê¸€ ë³€í™˜ (ë™ì‹œì— ìš”ì²­)
    const need = [rec, ...distractors];
    const korNames = await Promise.all(
      need.map(x => getKorName(x.nameEng))
    );

    // nameKor ì±„ì›Œë‘ê¸°
    korNames.forEach((k, i) => { need[i].nameKor = k; });

    const options = shuffle(need).map(x => ({ key: x.nameEng, label: x.nameKor || x.nameEng }));

    fitAndHighlight(rec);
    questionEl.textContent = "ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?";
    renderChoices(options, rec.nameEng);

    hintArea.textContent = `íŒíŠ¸: ëŒ€ë¥™ íŒíŠ¸ ë³´ì´ê¸° ğŸ”`;
  }

  function renderChoices(options, answerKeyEng) {
    choicesEl.innerHTML = "";
    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = opt.label;      // í™”ë©´ì—” í•œê¸€
      btn.dataset.key = opt.key;        // ë¹„êµëŠ” ì˜ë¬¸ í‚¤ë¡œ
      btn.onclick = () => {
        Array.from(document.querySelectorAll("button.choice")).forEach(b => b.disabled = true);
        const correct = (btn.dataset.key === answerKeyEng);
        if (correct) {
          score += 10;
          streak += 1;
          setResult(`ì •ë‹µ! âœ… ${opt.label}`, true);
        } else {
          streak = 0;
          // ì •ë‹µ í‘œì‹œë¥¼ í•œê¸€ë¡œ
          getKorName(answerKeyEng).then(k => setResult(`ì˜¤ë‹µ! âŒ ì •ë‹µì€ ${k}`, false));
        }
        updateBadges();
        btnNext.disabled = false;
      };
      choicesEl.appendChild(btn);
    });
  }

  function finish() {
    resetStyles();
    map.setView([20, 0], 2);
    questionEl.textContent = "ê²Œì„ ì¢…ë£Œ!";
    choicesEl.innerHTML = "";
    setResult(`ìµœì¢… ì ìˆ˜: ${score}ì  / ìµœëŒ€ ${TOTAL_QUESTIONS * 10}ì `, true);
    btnNext.disabled = true;
  }

  function restart() {
    score = 0; round = 0; streak = 0;
    remainingIds = allFeatures.map(r => r.id);
    updateBadges();
    nextQuestion();
  }

  // ì´ë²¤íŠ¸
  btnNext.onclick = nextQuestion;
  btnRestart.onclick = () => restart();
  btnHint.onclick = () => {
    if (!current) return;
    const k = continentKor[current.continent] || current.continent || "ì •ë³´ ì—†ìŒ";
    hintArea.textContent = `íŒíŠ¸: ëŒ€ë¥™ = ${k}`;
  };

  // ì‹œì‘
  (async function main() {
    initMap();
    await loadData();
    restart();
  })();
</script>
</body>
</html>
