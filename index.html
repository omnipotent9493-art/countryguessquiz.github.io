<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>세계지도 국가 맞히기 퀴즈</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html, body { height:100%; margin:0; font-family: "Noto Sans KR", sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr auto; }
    header, footer { padding:8px 14px; }
    header { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { background:#eee; border-radius:10px; padding:4px 10px; font-size:12px; }
    #map { width:100%; height:100%; background:#f3f5f8; }
    .panel { display:grid; gap:8px; padding:10px 14px; background:#fafafa; border-top:1px solid #ddd; }
    .question { font-weight:700; }
    .choices { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
    button.choice { padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#fff; }
    button.choice:hover { border-color:#666; }
    .result { min-height:24px; font-weight:600; }
    .controls { display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap; align-items:center; }
    .btn { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .progress { height:8px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background:#1a73e8; transition:width .3s; }
    .tiny { font-size:12px; color:#555; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="badge">🌍 세계지도 국가 맞히기</div>
    <div class="badge">빌드 v2025-08-30-8</div>
    <div class="badge" id="scoreBadge">점수 0</div>
    <div class="badge" id="roundBadge">문제 0/10</div>
    <div class="badge" id="streakBadge">연속정답 0</div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div class="question" id="question">이 나라가 어디일까요?</div>
    <div class="choices" id="choices"></div>
    <div class="result" id="result"></div>
    <div class="controls">
      <div class="tiny" id="hintArea">힌트: 버튼을 누르면 대륙 → 수도 → 음식/명소 순서로 나옵니다</div>
      <div>
        <button class="btn" id="btnHint">힌트</button>
        <button class="btn primary" id="btnNext" disabled>다음 문제</button>
        <button class="btn" id="btnRestart">처음부터</button>
      </div>
    </div>
  </div>

  <footer class="tiny">© 2025 국가퀴즈 — 국기출처: flagcdn.com</footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
const TOTAL_QUESTIONS=10,CHOICES_COUNT=4,HIGHLIGHT_COLOR="#ff5722";
let map,countryLayer,allFeatures=[],remainingIds=[],current=null,score=0,round=0,streak=0,hintLevel=0;

// === 캐시 & 매핑 ===
const korCache=new Map(),infoCache=new Map();
const nameFix={"South Korea":"Korea (Republic of)","North Korea":"Korea (Democratic People's Republic of)","USA":"United States"};
const overrides={"Korea (Republic of)":"대한민국","Korea (Democratic People's Republic of)":"북한","United States":"미국","China":"중국","Japan":"일본","France":"프랑스","Italy":"이탈리아","Brazil":"브라질","Germany":"독일","United Kingdom":"영국"};
const continentKor={"Africa":"아프리카","Americas":"아메리카","Asia":"아시아","Europe":"유럽","Oceania":"오세아니아"};
const foodHints={"Korea (Republic of)":"김치, 불고기","Japan":"스시, 라멘","Italy":"피자, 파스타","France":"바게트, 크루아상","United States":"햄버거, 핫도그","China":"만두, 훠궈","India":"커리, 비르야니","Brazil":"슈하스코","Mexico":"타코, 부리또"};
const landmarkHints={"France":"에펠탑","Italy":"콜로세움","United States":"자유의 여신상","China":"만리장성","Japan":"후지산","India":"타지마할","Brazil":"리우 예수상"};

// === UI ===
const scoreBadge=document.getElementById("scoreBadge"),roundBadge=document.getElementById("roundBadge"),streakBadge=document.getElementById("streakBadge"),progressBar=document.getElementById("progressBar"),choicesEl=document.getElementById("choices"),resultEl=document.getElementById("result"),hintArea=document.getElementById("hintArea"),btnHint=document.getElementById("btnHint"),btnNext=document.getElementById("btnNext"),btnRestart=document.getElementById("btnRestart"),questionEl=document.getElementById("question");

// === REST Countries ===
async function queryCountry(nameEng){
  const q=nameFix[nameEng]||nameEng;
  let url=`https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fullText=true&fields=name,translations,capital,region,cca2`;
  let res=await fetch(url);
  if(!res.ok){url=`https://restcountries.com/v3.1/name/${encodeURIComponent(q)}?fields=name,translations,capital,region,cca2`;res=await fetch(url);}
  if(res.ok){const d=await res.json();return Array.isArray(d)?d[0]:null;}
  return null;
}
async function getKorName(nameEng){
  if(korCache.has(nameEng))return korCache.get(nameEng);
  if(overrides[nameEng]){korCache.set(nameEng,overrides[nameEng]);return overrides[nameEng];}
  const hit=await queryCountry(nameEng);
  const kor=hit?.translations?.kor?.common||hit?.translations?.kor?.official||hit?.name?.common||nameEng;
  korCache.set(nameEng,kor);return kor;
}
async function getCountryInfo(nameEng){
  if(infoCache.has(nameEng))return infoCache.get(nameEng);
  const hit=await queryCountry(nameEng);
  const out={capital:hit?.capital?hit.capital[0]:null,cca2:hit?.cca2||null,region:hit?.region||null};
  infoCache.set(nameEng,out);return out;
}

// === 지도 ===
function initMap(){
  map=L.map("map",{renderer:L.svg(),zoomSnap:.1,minZoom:1.5});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:"&copy;OSM &copy;CARTO",subdomains:"abcd"}).addTo(map);
  map.setView([20,0],2);
}
async function loadData(){
  const topo=await fetch("https://unpkg.com/world-atlas@2/countries-110m.json").then(r=>r.json());
  const geo=topojson.feature(topo,topo.objects.countries);
  countryLayer=L.geoJSON(geo,{style:{weight:.8,color:"#888",fillColor:"#dfe7ef",fillOpacity:.8},onEachFeature:(f,l)=>{
    const name=f.properties?.name||f.properties?.admin;if(!name)return;
    allFeatures.push({id:String(f.id),nameEng:name,layer:l});
  }}).addTo(map);
  allFeatures=allFeatures.filter(r=>r.nameEng&&!/antarctica/i.test(r.nameEng));
  remainingIds=allFeatures.map(r=>r.id);
}

// === utils ===
const shuffle=a=>a.sort(()=>Math.random()-.5),sample=(a,n)=>shuffle(a.slice()).slice(0,n);
function updateBadges(){scoreBadge.textContent=`점수 ${score}`;roundBadge.textContent=`문제 ${round}/${TOTAL_QUESTIONS}`;streakBadge.textContent=`연속정답 ${streak}`;progressBar.style.width=`${(round/TOTAL_QUESTIONS)*100}%`;}
function setResult(t,ok){resultEl.textContent=t;resultEl.style.color=ok?"#0a7d2b":"#c62828";}

// === 국기 패턴 ===
function waitForPaths(rec){return new Promise(res=>{const tick=()=>{const el=rec.layer.getElement?.();if(el?.querySelectorAll("path").length)res(el);else requestAnimationFrame(tick);};tick();});}
async function fillWithFlag(rec){
  try{
    const info=await getCountryInfo(rec.nameEng);
    const code=info.cca2?.toLowerCase();if(!code)return;
    const flagUrl=`https://flagcdn.com/w320/${code}.png`;
    const head=await fetch(flagUrl,{method:"HEAD"});if(!head.ok)return;
    const groupEl=await waitForPaths(rec);
    const svg=map.getPane("overlayPane").querySelector("svg");if(!svg)return;
    let defs=svg.querySelector("defs");if(!defs){defs=document.createElementNS("http://www.w3.org/2000/svg","defs");svg.prepend(defs);}
    const bbox=groupEl.getBBox();const patId=`flagpat-${Math.random().toString(36).slice(2)}`;
    const pat=document.createElementNS("http://www.w3.org/2000/svg","pattern");
    pat.setAttribute("id",patId);pat.setAttribute("patternUnits","userSpaceOnUse");
    pat.setAttribute("x",bbox.x);pat.setAttribute("y",bbox.y);
    pat.setAttribute("width",bbox.width);pat.setAttribute("height",bbox.height);
    const img=document.createElementNS("http://www.w3.org/2000/svg","image");
    img.setAttributeNS("http://www.w3.org/1999/xlink","href",flagUrl);
    img.setAttribute("x",bbox.x);img.setAttribute("y",bbox.y);
    img.setAttribute("width",bbox.width);img.setAttribute("height",bbox.height);
    img.setAttribute("preserveAspectRatio","xMidYMid slice");
    pat.appendChild(img);defs.appendChild(pat);
    groupEl.querySelectorAll("path").forEach(p=>{p.setAttribute("fill",`url(#${patId})`);p.setAttribute("stroke","#111");p.setAttribute("stroke-width","2");});
  }catch(e){console.warn("flag error",e);}
}

// === 게임 ===
async function nextQuestion(){
  if(round>=TOTAL_QUESTIONS||remainingIds.length===0){finish();return;}
  round++;hintLevel=0;updateBadges();resultEl.textContent="";btnNext.disabled=true;
  const pickId=remainingIds.splice(Math.floor(Math.random()*remainingIds.length),1)[0];
  const rec=allFeatures.find(r=>r.id===pickId);current=rec;
  const others=allFeatures.filter(r=>r.id!==rec.id);const distractors=sample(others,CHOICES_COUNT-1);
  const need=[rec,...distractors];const korNames=await Promise.all(need.map(x=>getKorName(x.nameEng)));korNames.forEach((k,i)=>need[i].nameKor=k);
  const options=shuffle(need).map(x=>({key:x.nameEng,label:x.nameKor||x.nameEng}));
  rec.layer.setStyle({weight:2,color:"#111",fillColor:HIGHLIGHT_COLOR,fillOpacity:.7});map.fitBounds(rec.layer.getBounds().pad(.5));
  await fillWithFlag(rec);
  questionEl.textContent="이 나라가 어디일까요?";renderChoices(options,rec.nameEng);
  hintArea.textContent="힌트: 대륙 → 수도 → 음식/명소 순서로 나옵니다";
}
function renderChoices(options,ans){choicesEl.innerHTML="";options.forEach(opt=>{const b=document.createElement("button");b.className="choice";b.textContent=opt.label;b.onclick=()=>{document.querySelectorAll("button.choice").forEach(x=>x.disabled=true);if(opt.key===ans){score+=10;streak++;setResult(`정답! ✅ ${opt.label}`,true);}else{streak=0;getKorName(ans).then(k=>setResult(`오답! ❌ 정답은 ${k}`,false));}updateBadges();btnNext.disabled=false;};choicesEl.appendChild(b);});}
function finish(){questionEl.textContent="게임 종료!";choicesEl.innerHTML="";setResult(`최종 점수: ${score} / ${TOTAL_QUESTIONS*10}`,true);btnNext.disabled=true;}
function restart(){score=0;round=0;streak=0;remainingIds=allFeatures.map(r=>r.id);updateBadges();nextQuestion();}

// === 힌트 버튼 ===
btnHint.onclick=async()=>{if(!current)return;const info=await getCountryInfo(current.nameEng);const parts=[];if(hintLevel===0){parts.push("대륙: "+(continentKor[info.region]||info.region||"정보없음"));}else if(hintLevel===1){parts.push("수도: "+(info.capital||"정보없음"));}else{const key=nameFix[current.nameEng]||current.nameEng;if(foodHints[key])parts.push("대표 음식: "+foodHints[key]);if(landmarkHints[key])parts.push("유명한 곳: "+landmarkHints[key]);if(!foodHints[key]&&!landmarkHints[key])parts.push("추가힌트: 국기를 보세요 👀");}hintArea.textContent="힌트: "+parts.join(" | ");hintLevel=(hintLevel+1)%3;};
btnNext.onclick=nextQuestion;btnRestart.onclick=()=>restart();

// === 시작 ===
(async function(){initMap();await loadData();restart();})();
</script>
</body>
</html>
