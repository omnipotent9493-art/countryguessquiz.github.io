<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸° í€´ì¦ˆ</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr auto; }
    header, footer { padding: 10px 14px; }
    header { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .badge { background: #eee; border-radius: 10px; padding: 4px 10px; font-size: 12px; }
    #map { width: 100%; height: 100%; }
    .panel { display: grid; gap: 8px; padding: 10px 14px; background: #fafafa; border-top: 1px solid #eaeaea; }
    .question { font-weight: 700; }
    .choices { display: grid; gap: 8px; grid-template-columns: repeat(2,minmax(0,1fr)); }
    button.choice {
      padding: 10px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; font-size: 15px; background: white;
    }
    button.choice:hover { border-color: #aaa; }
    .result { min-height: 24px; font-weight: 600; }
    .controls { display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .btn {
      padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .progress { height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #1a73e8; transition: width .3s; }
    .tiny { font-size: 12px; color: #666; }
    @media (max-width: 640px) { .choices { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="badge">ğŸŒ ì„¸ê³„ì§€ë„ êµ­ê°€ ë§íˆê¸°</div>
      <div class="badge" id="scoreBadge">ì ìˆ˜ 0</div>
      <div class="badge" id="roundBadge">ë¬¸ì œ 0 / 10</div>
      <div class="badge" id="streakBadge">ì—°ì†ì •ë‹µ 0</div>
    </header>

    <div id="map"></div>

    <div class="panel">
      <div class="progress"><div class="bar" id="progressBar"></div></div>
      <div class="question" id="question">ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?</div>
      <div class="choices" id="choices"></div>
      <div class="result" id="result"></div>
      <div class="controls">
        <div class="tiny" id="hintArea">íŒíŠ¸: ëŒ€ë¥™ íŒíŠ¸ ë³´ì´ê¸° ğŸ”</div>
        <div>
          <button class="btn" id="btnHint">íŒíŠ¸</button>
          <button class="btn primary" id="btnNext" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
          <button class="btn" id="btnRestart">ì²˜ìŒë¶€í„°</button>
        </div>
      </div>
    </div>

    <footer class="tiny">
      íŒ: ì •ë‹µì„ ê³ ë¥´ë©´ ì§€ë„ì— **ê°•ì¡°**ê°€ ìœ ì§€ë˜ê³ , â€œë‹¤ìŒ ë¬¸ì œâ€ë¥¼ ëˆ„ë¥´ë©´ ìƒˆ êµ­ê°€ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.
    </footer>
  </div>

  <!-- Leaflet & TopoJSON -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <script>
    // ====== ì„¤ì •ê°’ ======
    const TOTAL_QUESTIONS = 10;      // í•œ íŒì— ë‚¼ ë¬¸ì œ ìˆ˜
    const CHOICES_COUNT   = 4;       // ë³´ê¸° ê°œìˆ˜
    const HIGHLIGHT_COLOR = "#ff5722";

    // ====== ì „ì—­ ìƒíƒœ ======
    let map, countryLayer;
    let allFeatures = [];            // {feature, name, continent, id}
    let remainingIds = [];           // ì•„ì§ ì•ˆ ë‚¸ êµ­ê°€ id ëª©ë¡
    let current = null;              // í˜„ì¬ ë¬¸ì œ {id, name, continent, layer}
    let score = 0, round = 0, streak = 0;

    // ====== UI ì°¸ì¡° ======
    const scoreBadge   = document.getElementById("scoreBadge");
    const roundBadge   = document.getElementById("roundBadge");
    const streakBadge  = document.getElementById("streakBadge");
    const progressBar  = document.getElementById("progressBar");
    const choicesEl    = document.getElementById("choices");
    const resultEl     = document.getElementById("result");
    const hintArea     = document.getElementById("hintArea");
    const btnHint      = document.getElementById("btnHint");
    const btnNext      = document.getElementById("btnNext");
    const btnRestart   = document.getElementById("btnRestart");
    const questionEl   = document.getElementById("question");

    // ====== ìœ í‹¸ ======
    const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
    const sample  = (arr, n) => shuffle(arr.slice()).slice(0, n);

    function updateBadges() {
      scoreBadge.textContent  = `ì ìˆ˜ ${score}`;
      roundBadge.textContent  = `ë¬¸ì œ ${round} / ${TOTAL_QUESTIONS}`;
      streakBadge.textContent = `ì—°ì†ì •ë‹µ ${streak}`;
      progressBar.style.width = `${(round / TOTAL_QUESTIONS) * 100}%`;
    }

    function setResult(text, ok) {
      resultEl.textContent = text;
      resultEl.style.color = ok ? "#0a7d2b" : "#c62828";
    }

    function resetStyles() {
      countryLayer.setStyle(defaultStyle);
    }

    // ====== ì§€ë„ ì´ˆê¸°í™” ======
    const defaultStyle = {
      weight: 0.7, color: "#999",
      fillColor: "#dfe7ef", fillOpacity: 0.7
    };

    const highlightStyle = {
      weight: 2, color: "#111",
      fillColor: HIGHLIGHT_COLOR, fillOpacity: 0.7
    };

    function initMap() {
      map = L.map("map", { zoomSnap: 0.1, worldCopyJump: false, minZoom: 1.5 });
      // ë² ì´ìŠ¤(ê·¸ë ˆì´ ìº”ë²„ìŠ¤ ëŠë‚Œ)
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);
      map.setView([20, 0], 2);
    }

    async function loadData() {
      // world-atlas TopoJSON â†’ GeoJSON ë³€í™˜
      const topo = await fetch("https://unpkg.com/world-atlas@2/countries-110m.json").then(r => r.json());
      const geo  = topojson.feature(topo, topo.objects.countries);

      // ì¼ë¶€ ë°°í¬ë³¸ì€ country nameì´ ë³„ë„ í…Œì´ë¸”ë¡œ ë¶„ë¦¬ë¼ ìˆìŒ
      // ì—¬ê¸°ì„œëŠ” êµ­ê°€ëª… ë§¤í•‘ìš© í…Œì´ë¸”ì„ ì¶”ê°€ë¡œ ë¶ˆëŸ¬ì˜´
      // source: https://unpkg.com/world-atlas@2/ (names-110m.json)
      let idToName = {};
      try {
        const names = await fetch("https://unpkg.com/world-atlas@2/world/110m.json").then(r => r.json());
        // world/110m.jsonì—ëŠ” countries, land ë“± í¬í•¨
        // countries ë°°ì—´ì— {id, name}ê°€ í¬í•¨ëœ ë³€í˜•ë³¸ì´ ìˆì–´ ì´ë¥¼ ìš°ì„  ì‹œë„
        if (names.countries && Array.isArray(names.countries)) {
          names.countries.forEach(c => { if (c.id != null && c.name) idToName[String(c.id)] = c.name; });
        }
      } catch(e) {
        // fallback: ê·¸ëƒ¥ id ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ì“°ë˜, ë‚˜ì¤‘ì— ê±¸ëŸ¬ì§
      }

      countryLayer = L.geoJSON(geo, {
        style: defaultStyle,
        onEachFeature: (feature, layer) => {
          const id   = String(feature.id ?? (feature.properties && feature.properties.id) ?? "");
          const name = feature.properties && (feature.properties.name || feature.properties.name_long || feature.properties.admin);
          const finalName = name || idToName[id] || null;

          if (!finalName) return; // ì´ë¦„ ì—†ëŠ” ê²½ìš° ìŠ¤í‚µ
          const rec = {
            id, name: finalName, continent: feature.properties && (feature.properties.continent || feature.properties.region_un || ""),
            feature, layer
          };
          allFeatures.push(rec);
        }
      }).addTo(map);

      // ë‚¨ê·¹, ì˜í•´ ë“± í•™ìŠµìš© ì œì™¸(ì´ë¦„ ê¸°ì¤€ ëŒ€ê°• í•„í„°)
      allFeatures = allFeatures.filter(r =>
        r.name && !/antarctica/i.test(r.name) && r.name.length >= 3
      );

      remainingIds = allFeatures.map(r => r.id);
    }

    function fitAndHighlight(rec) {
      resetStyles();
      rec.layer.setStyle(highlightStyle);
      try {
        const bounds = rec.layer.getBounds();
        map.fitBounds(bounds.pad(0.5), { animate: true, duration: 0.6 });
      } catch (e) {
        // MultiPolygonì´ ë„ˆë¬´ ì‘ìœ¼ë©´ ê¸°ë³¸ ì¤Œ
        map.setView([20, 0], 2);
      }
    }

    function nextQuestion() {
      if (round >= TOTAL_QUESTIONS || remainingIds.length === 0) {
        finish();
        return;
      }
      round++;
      updateBadges();
      resultEl.textContent = "";
      btnNext.disabled = true;

      // í›„ë³´ ì¤‘ í•˜ë‚˜ë¥¼ ë½‘ìŒ
      const pickId = remainingIds.splice(Math.floor(Math.random() * remainingIds.length), 1)[0];
      const rec = allFeatures.find(r => r.id === pickId);
      current = rec;

      // ë³´ê¸° ìƒì„± (ì •ë‹µ + ëœë¤ ì˜¤ë‹µ n-1)
      const others = allFeatures.filter(r => r.id !== rec.id);
      const distractors = sample(others, CHOICES_COUNT - 1);
      const options = shuffle([rec, ...distractors]).map(r => r.name);

      // ì§€ë„ ê°•ì¡° & UI ê·¸ë¦¬ê¸°
      fitAndHighlight(rec);
      questionEl.textContent = "ì´ ë‚˜ë¼ê°€ ì–´ë””ì¼ê¹Œìš”?";
      renderChoices(options, rec.name);

      // íŒíŠ¸ ì˜ì—­ ì´ˆê¸°í™”
      hintArea.textContent = "íŒíŠ¸: ëŒ€ë¥™ íŒíŠ¸ ë³´ì´ê¸° ğŸ”";
    }

    function renderChoices(options, answerName) {
      choicesEl.innerHTML = "";
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = opt;
        btn.onclick = () => {
          Array.from(document.querySelectorAll("button.choice")).forEach(b => b.disabled = true);
          const correct = (opt === answerName);
          if (correct) {
            score += 10;
            streak += 1;
            setResult(`ì •ë‹µ! âœ… ${answerName}`, true);
          } else {
            streak = 0;
            setResult(`ì˜¤ë‹µ! âŒ ì •ë‹µì€ ${answerName}`, false);
          }
          updateBadges();
          btnNext.disabled = false;
        };
        choicesEl.appendChild(btn);
      });
    }

    function finish() {
      resetStyles();
      map.setView([20, 0], 2);
      questionEl.textContent = "ê²Œì„ ì¢…ë£Œ!";
      choicesEl.innerHTML = "";
      setResult(`ìµœì¢… ì ìˆ˜: ${score}ì  / ìµœëŒ€ ${TOTAL_QUESTIONS * 10}ì `, true);
      btnNext.disabled = true;
    }

    function restart() {
      score = 0; round = 0; streak = 0;
      remainingIds = allFeatures.map(r => r.id);
      updateBadges();
      nextQuestion();
    }

    // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
    btnNext.onclick = nextQuestion;
    btnRestart.onclick = () => restart();
    btnHint.onclick = () => {
      if (!current) return;
      const text = current.continent ? `ëŒ€ë¥™: ${current.continent}` : "ëŒ€ë¥™ ì •ë³´ ì—†ìŒ";
      hintArea.textContent = `íŒíŠ¸: ${text}`;
    };

    // ====== ëŸ°íƒ€ì„ ì‹œì‘ ======
    (async function main() {
      initMap();
      await loadData();
      restart();
    })();
  </script>
</body>
</html>
